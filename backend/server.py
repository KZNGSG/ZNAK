from fastapi import FastAPI, HTTPException, BackgroundTasks, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import Response
from pydantic import BaseModel, EmailStr, field_validator
from typing import Optional, List, Dict
import os
from dotenv import load_dotenv
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
from email.utils import formataddr
import logging
import httpx
import uuid
from datetime import datetime
from urllib.parse import quote as url_quote

# –ò–º–ø–æ—Ä—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
from document_generator import generate_contract_pdf, generate_quote_pdf, generate_act_pdf

# –ò–º–ø–æ—Ä—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ë–î
from auth import (
    UserRegister, UserLogin, register_user, login_user,
    get_current_user, require_auth, require_admin, require_superadmin
)
from database import (
    CompanyDB, QuoteDB, ContractDB, CallbackDB, UserDB,
    get_next_contract_number, get_db
)

# Load environment variables first
load_dotenv()

app = FastAPI(title="–ü—Ä–æ.–ú–∞—Ä–∫–∏—Ä—É–π API")

# CORS configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ======================== MODELS ========================

class CategoryGroup(BaseModel):
    id: str
    name: str
    status: str  # "mandatory" or "experiment"
    subcategories: List[Dict[str, str]]

class CheckProductRequest(BaseModel):
    category: str
    subcategory: str
    product: Optional[str] = None  # Product ID from CATEGORIES_DATA
    source: List[str]  # ["produce", "import", "buy_rf", "old_stock"] - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
    volume: str  # "<100", "100-1000", "1000-10000", ">10000"

class CheckProductResponse(BaseModel):
    requires_marking: bool
    category: str
    subcategory: str
    subcategory_name: Optional[str] = None
    tnved: Optional[str] = None
    status: Optional[str] = None  # "mandatory" or "experiment"
    deadline: Optional[str] = None
    mandatory_since: Optional[str] = None
    timeline: Optional[Dict] = None  # Timeline info with who, requirements, etc.
    steps: List[str]
    message: str

class ImportRequest(BaseModel):
    country: str
    category: str

class ImportScheme(BaseModel):
    id: str
    title: str
    description: str
    pros: List[str]
    cons: List[str]
    fit_for: str

class EquipmentRequest(BaseModel):
    facility_type: str  # "production", "warehouse", "retail", "combined"
    daily_volume: str
    has_equipment: List[str]

class EquipmentItem(BaseModel):
    name: str
    purpose: str
    price_min: int
    price_max: int
    status: str  # "needed", "has"

class EquipmentResponse(BaseModel):
    items: List[EquipmentItem]
    budget_min: int
    budget_max: int

class ContactRequest(BaseModel):
    name: str
    phone: str
    email: Optional[EmailStr] = None
    request_type: str
    comment: Optional[str] = None
    consent: bool

    @field_validator('consent')
    @classmethod
    def check_consent(cls, v):
        if not v:
            raise ValueError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö')
        return v

# ======================== COMPANY LOOKUP ========================

class CompanyInfo(BaseModel):
    inn: str
    kpp: Optional[str] = None
    ogrn: Optional[str] = None
    name: str
    name_short: Optional[str] = None
    name_full: Optional[str] = None
    opf: Optional[str] = None  # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ-–ø—Ä–∞–≤–æ–≤–∞—è —Ñ–æ—Ä–º–∞
    type: Optional[str] = None  # LEGAL –∏–ª–∏ INDIVIDUAL
    address: Optional[str] = None
    management_name: Optional[str] = None
    management_post: Optional[str] = None
    status: Optional[str] = None  # ACTIVE, LIQUIDATED, etc.

class INNLookupRequest(BaseModel):
    inn: str

# ======================== QUOTE (–ö–ü) SYSTEM ========================

class QuoteService(BaseModel):
    id: str
    name: str
    description: Optional[str] = None
    price: float  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä–æ–±–Ω—ã–º (1.62 ‚ÇΩ)
    unit: str  # "—à—Ç", "—É—Å–ª—É–≥–∞", "–º–µ—Å—è—Ü"
    category: str
    quantity: int = 1

class QuoteProduct(BaseModel):
    id: str
    name: str
    tnved: str
    category: str

class QuoteRequest(BaseModel):
    company: CompanyInfo
    products: List[QuoteProduct]
    services: List[QuoteService]
    contact_name: str
    contact_phone: str
    contact_email: Optional[str] = None

class QuoteResponse(BaseModel):
    quote_id: str
    company_name: str
    total_amount: int
    services_breakdown: List[Dict]
    created_at: str
    valid_until: str

# ======================== –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ö–ê–¢–ï–ì–û–†–ò–ô ========================
# 3 —É—Ä–æ–≤–Ω—è: –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –¢–æ–≤–∞—Ä—ã (products)
# –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

CATEGORIES_DATA = [
    {
        "id": "food_drinks",
        "name": "–ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è –∏ –Ω–∞–ø–∏—Ç–∫–∏",
        "icon": "utensils",
        "subcategories": [
            {"id": "beer_alcohol", "name": "–ü–∏–≤–æ –∏ —Å–ª–∞–±–æ–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏", "icon": "beer", "products": []},
            {"id": "dairy", "name": "–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è", "icon": "milk", "products": [
                {
                    "id": "dairy_0401", "name": "–ú–æ–ª–æ–∫–æ –∏ —Å–ª–∏–≤–∫–∏ –Ω–µ—Å–≥—É—â–µ–Ω–Ω—ã–µ", "tnved": "0401",
                    "marking_status": "mandatory", "mandatory_since": "2021-12-01",
                    "timeline": {
                        "title": "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–æ 40 –¥–Ω–µ–π",
                        "start_date": "1 –¥–µ–∫–∞–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_0402", "name": "–ú–æ–ª–æ–∫–æ –∏ —Å–ª–∏–≤–∫–∏ —Å–≥—É—â–µ–Ω–Ω—ã–µ", "tnved": "0402",
                    "marking_status": "mandatory", "mandatory_since": "2021-09-01",
                    "timeline": {
                        "title": "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ 40 –¥–Ω–µ–π",
                        "start_date": "1 —Å–µ–Ω—Ç—è–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_0403", "name": "–ü–∞—Ö—Ç–∞, –π–æ–≥—É—Ä—Ç, –∫–µ—Ñ–∏—Ä", "tnved": "0403",
                    "marking_status": "mandatory", "mandatory_since": "2021-12-01",
                    "timeline": {
                        "title": "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–æ 40 –¥–Ω–µ–π",
                        "start_date": "1 –¥–µ–∫–∞–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_0404", "name": "–ú–æ–ª–æ—á–Ω–∞—è —Å—ã–≤–æ—Ä–æ—Ç–∫–∞", "tnved": "0404",
                    "marking_status": "mandatory", "mandatory_since": "2021-09-01",
                    "timeline": {
                        "title": "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ 40 –¥–Ω–µ–π",
                        "start_date": "1 —Å–µ–Ω—Ç—è–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_0405", "name": "–°–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ", "tnved": "0405",
                    "marking_status": "mandatory", "mandatory_since": "2021-09-01",
                    "timeline": {
                        "title": "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ 40 –¥–Ω–µ–π",
                        "start_date": "1 —Å–µ–Ω—Ç—è–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_0406", "name": "–°—ã—Ä—ã –∏ —Ç–≤–æ—Ä–æ–≥", "tnved": "0406",
                    "marking_status": "mandatory", "mandatory_since": "2021-06-01",
                    "timeline": {
                        "title": "–°—ã—Ä—ã ‚Äî –ø–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
                        "start_date": "1 –∏—é–Ω—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞", "–§–µ—Ä–º–µ—Ä—ã (—Å 1.09.2024)"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–†–∞–∑—Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –∫–∞—Å—Å–∞—Ö",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_210500", "name": "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ", "tnved": "2105 00",
                    "marking_status": "mandatory", "mandatory_since": "2021-06-01",
                    "timeline": {
                        "title": "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ ‚Äî –ø–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
                        "start_date": "1 –∏—é–Ω—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞", "–§–µ—Ä–º–µ—Ä—ã (—Å 1.09.2024)"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–†–∞–∑—Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –∫–∞—Å—Å–∞—Ö",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_2202999100", "name": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ (–¥–æ 0,2% –∂–∏—Ä–∞)", "tnved": "2202 99 910 0",
                    "marking_status": "mandatory", "mandatory_since": "2021-12-01",
                    "timeline": {
                        "title": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏",
                        "start_date": "1 –¥–µ–∫–∞–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_2202999500", "name": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ (0,2-2% –∂–∏—Ä–∞)", "tnved": "2202 99 950 0",
                    "marking_status": "mandatory", "mandatory_since": "2021-12-01",
                    "timeline": {
                        "title": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏",
                        "start_date": "1 –¥–µ–∫–∞–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                },
                {
                    "id": "dairy_2202999900", "name": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ (–æ—Ç 2% –∂–∏—Ä–∞)", "tnved": "2202 99 990 0",
                    "marking_status": "mandatory", "mandatory_since": "2021-12-01",
                    "timeline": {
                        "title": "–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏",
                        "start_date": "1 –¥–µ–∫–∞–±—Ä—è 2021",
                        "who": ["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏", "–ò–º–ø–æ—Ä—Ç—ë—Ä—ã", "–û–ø—Ç–æ–≤–∏–∫–∏", "–†–æ–∑–Ω–∏—Ü–∞"],
                        "current_requirements": [
                            "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
                            "–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
                            "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –∫–∞—Å—Å–µ",
                            "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)"
                        ]
                    }
                }
            ]},
            {"id": "water", "name": "–£–ø–∞–∫–æ–≤–∞–Ω–Ω–∞—è –≤–æ–¥–∞", "icon": "droplet", "products": []},
            {"id": "tobacco", "name": "–¢–∞–±–∞–∫", "icon": "cigarette", "products": []},
            {"id": "seafood", "name": "–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã (–∏–∫—Ä–∞)", "icon": "fish", "products": []},
            {"id": "oils", "name": "–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å–ª–∞", "icon": "flask", "products": []},
            {"id": "pet_food", "name": "–ö–æ—Ä–º–∞ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö", "icon": "paw", "products": []},
            {"id": "canned", "name": "–ö–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã", "icon": "archive", "products": []},
            {"id": "grocery", "name": "–ë–∞–∫–∞–ª–µ—è", "icon": "shopping-basket", "products": []},
            {"id": "soft_drinks", "name": "–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏", "icon": "glass-water", "products": []},
            {"id": "non_alc_beer", "name": "–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω–æ–µ –ø–∏–≤–æ", "icon": "beer", "products": []},
            {"id": "sweets", "name": "–°–ª–∞–¥–æ—Å—Ç–∏", "icon": "candy", "products": []},
            {"id": "instant_drinks", "name": "–†–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ –Ω–∞–ø–∏—Ç–∫–∏", "icon": "coffee", "products": []}
        ]
    },
    {
        "id": "pharma",
        "name": "–§–∞—Ä–º–∞—Ü–µ–≤—Ç–∏–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ",
        "icon": "pill",
        "subcategories": [
            {"id": "medicines", "name": "–õ–µ–∫–∞—Ä—Å—Ç–≤–∞", "icon": "pill", "products": []},
            {"id": "tsr", "name": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–∏ (–¢–°–†)", "icon": "accessibility", "products": []},
            {"id": "vet", "name": "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã", "icon": "stethoscope", "products": []},
            {"id": "pharma_raw", "name": "–§–∞—Ä–º–∞—Ü–µ–≤—Ç–∏—á–µ—Å–∫–æ–µ —Å—ã—Ä—å—ë, –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞", "icon": "flask", "products": []},
            {"id": "medical_devices", "name": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–∑–¥–µ–ª–∏—è", "icon": "heart-pulse", "products": []},
            {"id": "supplements", "name": "–ë–ê–î", "icon": "apple", "products": []},
            {"id": "antiseptics", "name": "–ê–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–∏ –∏ –¥–µ–∑–∏–Ω—Ñ–∏—Ü–∏—Ä—É—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞", "icon": "spray-can", "products": []},
            {"id": "wheelchairs", "name": "–ö—Ä–µ—Å–ª–∞-–∫–æ–ª—è—Å–∫–∏", "icon": "wheelchair", "products": []},
            {"id": "sports_nutrition", "name": "–°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ", "icon": "dumbbell", "products": []}
        ]
    },
    {
        "id": "cosmetics",
        "name": "–ö–æ—Å–º–µ—Ç–∏–∫–∞, –≥–∏–≥–∏–µ–Ω–∞ –∏ –±—ã—Ç–æ–≤–∞—è —Ö–∏–º–∏—è",
        "icon": "sparkles",
        "subcategories": [
            {"id": "perfume", "name": "–î—É—Ö–∏ –∏ —Ç—É–∞–ª–µ—Ç–Ω–∞—è –≤–æ–¥–∞", "icon": "spray-can", "products": []},
            {"id": "cosmetics_hygiene", "name": "–ö–æ—Å–º–µ—Ç–∏–∫–∞, –±—ã—Ç–æ–≤–∞—è —Ö–∏–º–∏—è –∏ —Ç–æ–≤–∞—Ä—ã –ª–∏—á–Ω–æ–π –≥–∏–≥–∏–µ–Ω—ã", "icon": "sparkles", "products": []}
        ]
    },
    {
        "id": "non_food",
        "name": "–ù–µ–ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã",
        "icon": "box",
        "subcategories": [
            {"id": "light_industry", "name": "–¢–æ–≤–∞—Ä—ã –ª—ë–≥–∫–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏", "icon": "shirt", "products": []},
            {"id": "shoes", "name": "–û–±—É–≤—å", "icon": "footprints", "products": []},
            {"id": "furs", "name": "–®—É–±—ã", "icon": "shirt", "products": []},
            {"id": "toys", "name": "–î–µ—Ç—Å–∫–∏–µ –∏–≥—Ä—É—à–∫–∏", "icon": "puzzle", "products": []},
            {"id": "bicycles", "name": "–í–µ–ª–æ—Å–∏–ø–µ–¥—ã", "icon": "bike", "products": []}
        ]
    },
    {
        "id": "auto",
        "name": "–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–∞—è –æ—Ç—Ä–∞—Å–ª—å",
        "icon": "car",
        "subcategories": [
            {"id": "tires", "name": "–®–∏–Ω—ã –∏ –ø–æ–∫—Ä—ã—à–∫–∏", "icon": "circle", "products": []},
            {"id": "motor_oils", "name": "–ú–æ—Ç–æ—Ä–Ω—ã–µ –º–∞—Å–ª–∞", "icon": "droplet", "products": []}
        ]
    },
    {
        "id": "construction",
        "name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞",
        "icon": "hard-hat",
        "subcategories": [
            {"id": "building_materials", "name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", "icon": "hammer", "products": []}
        ]
    },
    {
        "id": "electronics",
        "name": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–∏–∫–∞",
        "icon": "cpu",
        "subcategories": [
            {"id": "cameras", "name": "–§–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç—ã –∏ –ª–∞–º–ø—ã-–≤—Å–ø—ã—à–∫–∏", "icon": "camera", "products": []}
        ]
    },
    {
        "id": "pilot",
        "name": "–ü–∏–ª–æ—Ç–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã",
        "icon": "rocket",
        "subcategories": [
            {"id": "titanium", "name": "–¢–∏—Ç–∞–Ω–æ–≤–∞—è –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–¥—É–∫—Ü–∏—è (–∑–∞–≤–µ—Ä—à—ë–Ω)", "icon": "box", "products": []},
            {"id": "radio_electronics", "name": "–†–∞–¥–∏–æ—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", "icon": "radio", "products": []},
            {"id": "fiber_optic", "name": "–û–ø—Ç–æ–≤–æ–ª–æ–∫–Ω–æ", "icon": "cable", "products": []},
            {"id": "print_products", "name": "–ü–µ—á–∞—Ç–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (–∑–∞–≤–µ—Ä—à–µ–Ω)", "icon": "book", "products": []},
            {"id": "heating", "name": "–û—Ç–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–±–æ—Ä—ã", "icon": "thermometer", "products": []},
            {"id": "cables", "name": "–ö–∞–±–µ–ª—å–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è", "icon": "cable", "products": []},
            {"id": "low_alcohol", "name": "–°–ª–∞–±—ã–π –∞–ª–∫–æ–≥–æ–ª—å", "icon": "wine", "products": []},
            {"id": "medical_2", "name": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–∑–¥–µ–ª–∏—è 2.0", "icon": "stethoscope", "products": []},
            {"id": "pyrotechnics", "name": "–ü–∏—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞", "icon": "sparkles", "products": []},
            {"id": "polymer_pipes", "name": "–ü–æ–ª–∏–º–µ—Ä–Ω—ã–µ —Ç—Ä—É–±—ã", "icon": "cylinder", "products": []},
            {"id": "auto_parts", "name": "–ê–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏", "icon": "wrench", "products": []},
            {"id": "hygiene", "name": "–°—Ä–µ–¥—Å—Ç–≤–∞ –≥–∏–≥–∏–µ–Ω—ã", "icon": "sparkles", "products": []},
            {"id": "home_interior", "name": "–¢–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞ –∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞", "icon": "home", "products": []},
            {"id": "fertilizers", "name": "–£–¥–æ–±—Ä–µ–Ω–∏—è", "icon": "leaf", "products": []},
            {"id": "pasta_cereals", "name": "–ú–∞–∫–∞—Ä–æ–Ω—ã, –∫—Ä—É–ø—ã, –º—ë–¥", "icon": "wheat", "products": []},
            {"id": "meat_products", "name": "–ú—è—Å–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è", "icon": "beef", "products": []},
            {"id": "frozen_food", "name": "–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã –∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è", "icon": "snowflake", "products": []}
        ]
    }
]

# Build lookup dictionary for quick access (–Ω–æ–≤–∞—è 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
PRODUCTS_LOOKUP = {}
for category in CATEGORIES_DATA:
    for sub in category.get("subcategories", []):
        for product in sub.get("products", []):
            PRODUCTS_LOOKUP[product["id"]] = {
                "category_id": category["id"],
                "category_name": category["name"],
                "subcategory_id": sub["id"],
                "subcategory_name": sub["name"],
                "name": product["name"],
                "tnved": product.get("tnved", ""),
                "marking_status": product.get("marking_status", "not_required"),
                "mandatory_since": product.get("mandatory_since"),
                "timeline": product.get("timeline")
            }

MARKING_STEPS = [
    "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ –ß–µ—Å—Ç–Ω—ã–π –ó–ù–ê–ö (—á–µ—Å—Ç–Ω—ã–π–∑–Ω–∞–∫.—Ä—Ñ)",
    "–ü–æ–ª—É—á–∏—Ç—å —É—Å–∏–ª–µ–Ω–Ω—É—é –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å—å (–£–ö–≠–ü)",
    "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç (–≠–î–û)",
    "–ó–∞–∫–∞–∑–∞—Ç—å –∫–æ–¥—ã –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ",
    "–ù–∞–Ω–µ—Å—Ç–∏ –∫–æ–¥—ã –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä (–ø—Ä–∏–Ω—Ç–µ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫)",
    "–í–≤–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –≤ –æ–±–æ—Ä–æ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ß–µ—Å—Ç–Ω—ã–π –ó–ù–ê–ö"
]

EXPERIMENT_STEPS = [
    "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è",
    "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏ –Ω–∞ —Å–∞–π—Ç–µ —á–µ—Å—Ç–Ω—ã–π–∑–Ω–∞–∫.—Ä—Ñ",
    "–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ –∑–∞–±–ª–∞–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (–≠–î–û, –ø—Ä–∏–Ω—Ç–µ—Ä—ã —ç—Ç–∏–∫–µ—Ç–æ–∫)"
]

COUNTRIES = [
    {"code": "AE", "name": "–û–ê–≠ (–î—É–±–∞–π)", "flag": "üá¶üá™"},
    {"code": "CN", "name": "–ö–∏—Ç–∞–π", "flag": "üá®üá≥"},
    {"code": "TR", "name": "–¢—É—Ä—Ü–∏—è", "flag": "üáπüá∑"},
    {"code": "KZ", "name": "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "flag": "üá∞üáø"},
    {"code": "BY", "name": "–ë–µ–ª–∞—Ä—É—Å—å", "flag": "üáßüáæ"},
    {"code": "EU", "name": "–ï–≤—Ä–æ–ø–∞", "flag": "üá™üá∫"},
    {"code": "OTHER", "name": "–î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞", "flag": "üåç"}
]

IMPORT_SCHEMES = [
    {
        "id": "abroad",
        "title": "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∑–∞ —Ä—É–±–µ–∂–æ–º",
        "description": "–í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–æ–¥—ã –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É, –æ–Ω –Ω–∞–Ω–æ—Å–∏—Ç –∏—Ö –Ω–∞ —Ç–æ–≤–∞—Ä, —Ç–æ–≤–∞—Ä –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–∂–µ –ø—Ä–æ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
        "pros": ["–¢–æ–≤–∞—Ä —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∂–µ", "–ù–µ –Ω—É–∂–Ω–æ —Å–≤–æ—ë –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"],
        "cons": ["–ù—É–∂–µ–Ω –Ω–∞–¥—ë–∂–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫", "–°–ª–æ–∂–Ω–µ–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ"],
        "fit_for": "–ö—Ä—É–ø–Ω—ã—Ö —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫"
    },
    {
        "id": "customs_warehouse",
        "title": "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ",
        "description": "–¢–æ–≤–∞—Ä –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–µ–∑ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏, –º–∞—Ä–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ –≤ –†–æ—Å—Å–∏–∏ –¥–æ –≤—ã–ø—É—Å–∫–∞ –≤ –æ–±–æ—Ä–æ—Ç",
        "pros": ["–ù–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞", "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"],
        "cons": ["–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞", "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏"],
        "fit_for": "–°—Ä–µ–¥–Ω–∏—Ö –ø–∞—Ä—Ç–∏–π, —Ä–∞–∑–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"
    },
    {
        "id": "own_warehouse",
        "title": "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å–≤–æ—ë–º —Å–∫–ª–∞–¥–µ",
        "description": "–¢–æ–≤–∞—Ä —Ä–∞—Å—Ç–∞–º–∞–∂–∏–≤–∞–µ—Ç—Å—è, –≤—ã –º–∞—Ä–∫–∏—Ä—É–µ—Ç–µ –µ–≥–æ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –Ω–∞ —Å–≤–æ—ë–º —Å–∫–ª–∞–¥–µ",
        "pros": ["–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö"],
        "cons": ["–ù—É–∂–Ω–æ —Å–≤–æ—ë –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±—É—á–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª"],
        "fit_for": "–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤"
    }
]

EQUIPMENT_DATABASE = {
    "printer": {"name": "–ü—Ä–∏–Ω—Ç–µ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫", "purpose": "–ü–µ—á–∞—Ç—å DataMatrix –∫–æ–¥–æ–≤ –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–∞—Ö", "price_min": 15000, "price_max": 80000},
    "scanner": {"name": "–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤", "purpose": "–°—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏", "price_min": 8000, "price_max": 35000},
    "tsd": {"name": "–¢–µ—Ä–º–∏–Ω–∞–ª —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–¢–°–î)", "purpose": "–ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤", "price_min": 25000, "price_max": 70000},
    "software": {"name": "–ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—á—ë—Ç–∞", "purpose": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ß–µ—Å—Ç–Ω—ã–º –ó–ù–ê–ö–æ–º, —É—á—ë—Ç –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤", "price_min": 0, "price_max": 50000}
}

# ======================== –ü–†–ê–ô–°-–õ–ò–°–¢ –£–°–õ–£–ì ========================

# –ü—Ä–∞–π—Å-–ª–∏—Å—Ç —É—Å–ª—É–≥ (—Ü–µ–Ω—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π +35%)
# –£—Å–ª—É–≥–∏ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏–º–µ—é—Ç min_qty –∏ max_qty –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ —Ü–µ–Ω—ã
SERVICES_PRICELIST = [
    # 1. –ê—É–¥–∏—Ç —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞ - –ë–ï–°–ü–õ–ê–¢–ù–û
    {
        "id": "audit",
        "name": "–ê—É–¥–∏—Ç —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞",
        "description": "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞—É–¥–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞ –∫ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ",
        "price": 0,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "setup",
        "order": 1
    },
    # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞ - 4500 + 35% = 6075
    {
        "id": "workplace_setup",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞",
        "description": "–ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞—Ä–∫–∏—Ä–æ–≤–∫–æ–π",
        "price": 6075,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "setup",
        "order": 2
    },
    # 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ - 1800 + 35% = 2430
    {
        "id": "reg_chz",
        "name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–ù–ê–ö–µ",
        "description": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –ß–µ—Å—Ç–Ω—ã–π –ó–ù–ê–ö",
        "price": 2430,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "registration",
        "order": 3
    },
    # 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º –ö–∞—Ç–∞–ª–æ–≥–µ - 2500 + 35% = 3375
    {
        "id": "reg_catalog",
        "name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º –ö–∞—Ç–∞–ª–æ–≥–µ",
        "description": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ —Ç–æ–≤–∞—Ä–æ–≤",
        "price": 3375,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "registration",
        "order": 4
    },
    # 5. –ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN) - —Ç–∞—Ä–∏—Ñ—ã —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
    {
        "id": "gtin_1_5",
        "name": "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ–º GTIN",
        "price": 1620,
        "unit": "—à—Ç",
        "category": "gtin",
        "tier": "1-5",
        "min_qty": 1,
        "max_qty": 5,
        "order": 5
    },
    {
        "id": "gtin_6_50",
        "name": "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ–º GTIN",
        "price": 810,
        "unit": "—à—Ç",
        "category": "gtin",
        "tier": "6-50",
        "min_qty": 6,
        "max_qty": 50,
        "order": 5
    },
    {
        "id": "gtin_51_500",
        "name": "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ–º GTIN",
        "price": 540,
        "unit": "—à—Ç",
        "category": "gtin",
        "tier": "51-500",
        "min_qty": 51,
        "max_qty": 500,
        "order": 5
    },
    {
        "id": "gtin_501_2000",
        "name": "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ–º GTIN",
        "price": 432,
        "unit": "—à—Ç",
        "category": "gtin",
        "tier": "501-2000",
        "min_qty": 501,
        "max_qty": 2000,
        "order": 5
    },
    {
        "id": "gtin_2000_plus",
        "name": "–ó–∞–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ–º GTIN",
        "price": 270,
        "unit": "—à—Ç",
        "category": "gtin",
        "tier": "–æ—Ç 2000",
        "min_qty": 2001,
        "max_qty": 999999,
        "order": 5
    },
    # 6. –í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ - —Ç–∞—Ä–∏—Ñ—ã —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
    {
        "id": "codes_1_500",
        "name": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
        "description": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ß–ó",
        "price": 1.62,
        "unit": "—à—Ç",
        "category": "codes",
        "tier": "1-500",
        "min_qty": 1,
        "max_qty": 500,
        "order": 6
    },
    {
        "id": "codes_501_5000",
        "name": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
        "description": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ß–ó",
        "price": 1.22,
        "unit": "—à—Ç",
        "category": "codes",
        "tier": "501-5000",
        "min_qty": 501,
        "max_qty": 5000,
        "order": 6
    },
    {
        "id": "codes_5001_50000",
        "name": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
        "description": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ß–ó",
        "price": 1.08,
        "unit": "—à—Ç",
        "category": "codes",
        "tier": "5001-50000",
        "min_qty": 5001,
        "max_qty": 50000,
        "order": 6
    },
    {
        "id": "codes_50000_plus",
        "name": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
        "description": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ß–ó",
        "price": 0.68,
        "unit": "—à—Ç",
        "category": "codes",
        "tier": "–æ—Ç 50000",
        "min_qty": 50001,
        "max_qty": 999999,
        "order": 6
    },
    # 7. –í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç - —Ç–∞—Ä–∏—Ñ—ã —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
    {
        "id": "turnover_1_500",
        "name": "–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç",
        "description": "–í–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–±–æ—Ä–æ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ß–ó",
        "price": 1.35,
        "unit": "—à—Ç",
        "category": "turnover",
        "tier": "1-500",
        "min_qty": 1,
        "max_qty": 500,
        "order": 7
    },
    {
        "id": "turnover_501_5000",
        "name": "–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç",
        "description": "–í–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–±–æ—Ä–æ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ß–ó",
        "price": 1.08,
        "unit": "—à—Ç",
        "category": "turnover",
        "tier": "501-5000",
        "min_qty": 501,
        "max_qty": 5000,
        "order": 7
    },
    {
        "id": "turnover_5001_50000",
        "name": "–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç",
        "description": "–í–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–±–æ—Ä–æ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ß–ó",
        "price": 0.81,
        "unit": "—à—Ç",
        "category": "turnover",
        "tier": "5001-50000",
        "min_qty": 5001,
        "max_qty": 50000,
        "order": 7
    },
    {
        "id": "turnover_50000_plus",
        "name": "–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç",
        "description": "–í–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–±–æ—Ä–æ—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ß–ó",
        "price": 0.68,
        "unit": "—à—Ç",
        "category": "turnover",
        "tier": "–æ—Ç 50000",
        "min_qty": 50001,
        "max_qty": 999999,
        "order": 7
    },
    # 8. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î - —Ç–∞—Ä–∏—Ñ—ã —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
    {
        "id": "upd_1_10",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î",
        "description": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
        "price": 405,
        "unit": "—à—Ç",
        "category": "upd",
        "tier": "1-10",
        "min_qty": 1,
        "max_qty": 10,
        "order": 8
    },
    {
        "id": "upd_11_30",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î",
        "description": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
        "price": 203,
        "unit": "—à—Ç",
        "category": "upd",
        "tier": "11-30",
        "min_qty": 11,
        "max_qty": 30,
        "order": 8
    },
    {
        "id": "upd_31_100",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î",
        "description": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
        "price": 135,
        "unit": "—à—Ç",
        "category": "upd",
        "tier": "31-100",
        "min_qty": 31,
        "max_qty": 100,
        "order": 8
    },
    {
        "id": "upd_100_plus",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î",
        "description": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
        "price": 68,
        "unit": "—à—Ç",
        "category": "upd",
        "tier": "–æ—Ç 100",
        "min_qty": 101,
        "max_qty": 999999,
        "order": 8
    },
    # 9. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≠–î–û - 3500 + 35% = 4725
    {
        "id": "edo_setup",
        "name": "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≠–î–û",
        "description": "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞",
        "price": 4725,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "edo",
        "order": 9
    },
    # 10. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è - 2500 + 35% = 3375
    {
        "id": "equipment_setup",
        "name": "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
        "description": "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞—Ä–∫–∏—Ä–æ–≤–∫–æ–π",
        "price": 3375,
        "unit": "—É—Å–ª—É–≥–∞",
        "category": "equipment",
        "order": 10
    },
    # 11. –°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤ (–ö–ú) - —Ç–∞—Ä–∏—Ñ—ã —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
    {
        "id": "kiz_1_500",
        "name": "–°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤ (–ö–ú)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤",
        "price": 2.03,
        "unit": "—à—Ç",
        "category": "kiz",
        "tier": "1-500",
        "min_qty": 1,
        "max_qty": 500,
        "order": 11
    },
    {
        "id": "kiz_501_5000",
        "name": "–°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤ (–ö–ú)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤",
        "price": 1.62,
        "unit": "—à—Ç",
        "category": "kiz",
        "tier": "501-5000",
        "min_qty": 501,
        "max_qty": 5000,
        "order": 11
    },
    {
        "id": "kiz_5001_50000",
        "name": "–°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤ (–ö–ú)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤",
        "price": 1.35,
        "unit": "—à—Ç",
        "category": "kiz",
        "tier": "5001-50000",
        "min_qty": 5001,
        "max_qty": 50000,
        "order": 11
    },
    {
        "id": "kiz_50000_plus",
        "name": "–°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤ (–ö–ú)",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤",
        "price": 1.08,
        "unit": "—à—Ç",
        "category": "kiz",
        "tier": "–æ—Ç 50000",
        "min_qty": 50001,
        "max_qty": 999999,
        "order": 11
    },
    # 12. –û–±—É—á–µ–Ω–∏–µ/—Å–µ—Ä–≤–∏—Å - 1900 + 35% = 2565
    {
        "id": "training",
        "name": "–û–±—É—á–µ–Ω–∏–µ/—Å–µ—Ä–≤–∏—Å",
        "description": "–û–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç–µ —Å —Å–∏—Å—Ç–µ–º–æ–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–ø–æ—á–∞—Å–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞)",
        "price": 2565,
        "unit": "—á–∞—Å",
        "category": "training",
        "order": 12
    },
]

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥: tiered=True –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å–ª—É–≥—É —Å —Ç–∞—Ä–∏—Ñ–Ω–æ–π —Å–µ—Ç–∫–æ–π (–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä)
SERVICE_CATEGORIES = {
    "setup": {"name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞", "icon": "settings", "order": 1, "tiered": False},
    "registration": {"name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", "icon": "clipboard-check", "order": 2, "tiered": False},
    "gtin": {"name": "–ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (GTIN)", "icon": "tag", "order": 3, "tiered": True},
    "codes": {"name": "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏", "icon": "qr-code", "order": 4, "tiered": True},
    "turnover": {"name": "–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç", "icon": "arrow-right-circle", "order": 5, "tiered": True},
    "upd": {"name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –£–ü–î", "icon": "file-text", "order": 6, "tiered": True},
    "edo": {"name": "–≠–î–û", "icon": "send", "order": 7, "tiered": False},
    "equipment": {"name": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "icon": "printer", "order": 8, "tiered": False},
    "kiz": {"name": "–°–æ–∑–¥–∞–Ω–∏–µ –ö–ò–ó–æ–≤", "icon": "barcode", "order": 9, "tiered": True},
    "training": {"name": "–û–±—É—á–µ–Ω–∏–µ", "icon": "graduation-cap", "order": 10, "tiered": False},
}

# ======================== EMAIL FUNCTIONS ========================

def send_email(to_email: str, subject: str, body: str) -> bool:
    """Send email via SMTP with Beget configuration"""
    # Beget SMTP defaults (–ø–æ—Ä—Ç 465 SSL - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ)
    smtp_host = os.getenv('SMTP_HOST', 'smtp.beget.com')
    smtp_port = os.getenv('SMTP_PORT', '465')
    smtp_user = os.getenv('SMTP_USER', 'noreply@promarkirui.ru')
    smtp_pass = os.getenv('SMTP_PASSWORD', 'wK2jnyo*t7jm')  # SMTP_PASSWORD (–Ω–µ SMTP_PASS)
    smtp_from = os.getenv('SMTP_FROM', smtp_user)
    smtp_use_tls = os.getenv('SMTP_USE_TLS', 'false').lower() == 'true'  # false = use SSL

    # Log email attempt
    logger.info(f"Sending email to {to_email}, subject: {subject}")

    try:
        msg = MIMEMultipart('alternative')
        msg['Subject'] = Header(subject, 'utf-8')
        msg['From'] = formataddr((str(Header('–ü—Ä–æ.–ú–∞—Ä–∫–∏—Ä—É–π', 'utf-8')), smtp_from))
        msg['To'] = to_email

        part = MIMEText(body, 'html', 'utf-8')
        msg.attach(part)

        if smtp_use_tls:
            server = smtplib.SMTP(smtp_host, int(smtp_port))
            server.starttls()
        else:
            server = smtplib.SMTP_SSL(smtp_host, int(smtp_port))

        server.login(smtp_user, smtp_pass)
        server.send_message(msg)
        server.quit()

        logger.info(f"Email sent successfully to {to_email}")
        return True
    except Exception as e:
        logger.error(f"Failed to send email: {str(e)}")
        return False

def format_contact_email(data: ContactRequest) -> str:
    """Format contact form data into HTML email"""
    now = datetime.now().strftime("%d.%m.%Y %H:%M")
    return f"""
    <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: linear-gradient(135deg, #FFDA07 0%, #F5C300 100%); padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; color: #000;">–ó–∞—è–≤–∫–∞ –Ω–∞ {data.request_type}</h2>
            </div>
            <div style="background: #fff; padding: 20px; border: 1px solid #eee; border-top: none; border-radius: 0 0 12px 12px;">
                <table style="border-collapse: collapse; width: 100%; max-width: 600px;">
                    <tr>
                        <td style="padding: 12px; background-color: #f8f9fa; font-weight: bold; width: 150px;">–ò–º—è:</td>
                        <td style="padding: 12px; font-size: 16px;">{data.name}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; background-color: #f8f9fa; font-weight: bold;">–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                        <td style="padding: 12px; font-size: 16px;"><a href="tel:{data.phone}" style="color: #1E3A8A;">{data.phone}</a></td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; background-color: #f8f9fa; font-weight: bold;">Email:</td>
                        <td style="padding: 12px;">{f'<a href="mailto:{data.email}" style="color: #1E3A8A;">{data.email}</a>' if data.email else '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; background-color: #f8f9fa; font-weight: bold;">–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:</td>
                        <td style="padding: 12px;">{data.request_type}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; background-color: #f8f9fa; font-weight: bold;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</td>
                        <td style="padding: 12px;">{data.comment or '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                </table>
                <p style="margin-top: 20px; color: #666; font-size: 12px;">
                    –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {now}<br>
                    –° —Å–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                </p>
            </div>
        </body>
    </html>
    """

# ======================== API ENDPOINTS ========================

@app.get("/api/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "ok", "service": "promarkirui", "products_count": len(PRODUCTS_LOOKUP)}

@app.get("/api/check/categories")
async def get_categories():
    """Get all product categories and subcategories"""
    return {"groups": CATEGORIES_DATA}

@app.post("/api/check/assess", response_model=CheckProductResponse)
async def assess_product(request: CheckProductRequest):
    """Assess if product requires marking"""

    # Look up product by product ID first, then by subcategory
    product = None
    if request.product:
        product = PRODUCTS_LOOKUP.get(request.product)

    if product:
        marking_status = product.get("marking_status", "not_required")
        is_mandatory = marking_status == "mandatory"
        is_experiment = marking_status == "experiment"
        timeline = product.get("timeline")
        mandatory_since = product.get("mandatory_since")

        if is_mandatory:
            # Format deadline from timeline
            deadline = f"—Å {timeline['start_date']}" if timeline else "–î–µ–π—Å—Ç–≤—É–µ—Ç"

            return CheckProductResponse(
                requires_marking=True,
                category=request.category,
                subcategory=request.subcategory,
                subcategory_name=product["name"],
                tnved=product["tnved"],
                status="mandatory",
                deadline=deadline,
                mandatory_since=mandatory_since,
                timeline=timeline,
                steps=timeline.get("current_requirements", MARKING_STEPS) if timeline else MARKING_STEPS,
                message=f"–¢–æ–≤–∞—Ä ¬´{product['name']}¬ª –ø–æ–¥–ª–µ–∂–∏—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ. –ö–æ–¥ –¢–ù –í–≠–î: {product['tnved']}"
            )
        elif is_experiment:
            return CheckProductResponse(
                requires_marking=False,
                category=request.category,
                subcategory=request.subcategory,
                subcategory_name=product["name"],
                tnved=product["tnved"],
                status="experiment",
                deadline="–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç",
                mandatory_since=None,
                timeline=timeline,
                steps=EXPERIMENT_STEPS,
                message=f"–¢–æ–≤–∞—Ä ¬´{product['name']}¬ª —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ –ø–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ. –ö–æ–¥ –¢–ù –í–≠–î: {product['tnved']}. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–∫–∞ –Ω–µ –≤–≤–µ–¥–µ–Ω–∞."
            )

    return CheckProductResponse(
        requires_marking=False,
        category=request.category,
        subcategory=request.subcategory,
        tnved=None,
        status=None,
        deadline=None,
        mandatory_since=None,
        timeline=None,
        steps=[],
        message="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ —á–µ—Å—Ç–Ω—ã–π–∑–Ω–∞–∫.—Ä—Ñ"
    )

@app.get("/api/import/countries")
async def get_countries():
    """Get list of countries for import"""
    return {"countries": COUNTRIES}

@app.get("/api/import/categories")
async def get_import_categories():
    """Get categories for import (reuse check categories)"""
    return {"groups": CATEGORIES_DATA}

@app.get("/api/import/schemes")
async def get_import_schemes(country: str, category: str):
    """Get import schemes for selected country and category"""
    return {"schemes": IMPORT_SCHEMES}

@app.post("/api/equipment/recommend", response_model=EquipmentResponse)
async def recommend_equipment(request: EquipmentRequest):
    """Recommend equipment based on facility type and volume"""

    items = []
    total_min = 0
    total_max = 0

    for eq_id, eq_data in EQUIPMENT_DATABASE.items():
        has_it = eq_id in request.has_equipment
        status = "has" if has_it else "needed"

        items.append(EquipmentItem(
            name=eq_data["name"],
            purpose=eq_data["purpose"],
            price_min=eq_data["price_min"],
            price_max=eq_data["price_max"],
            status=status
        ))

        if not has_it:
            total_min += eq_data["price_min"]
            total_max += eq_data["price_max"]

    return EquipmentResponse(
        items=items,
        budget_min=total_min,
        budget_max=total_max
    )

@app.post("/api/contact/send")
async def send_contact(request: ContactRequest, background_tasks: BackgroundTasks):
    """Send contact form to email"""

    contact_email = os.getenv('CONTACT_TO_EMAIL', 'damirslk@mail.ru')
    subject = f"–ó–∞—è–≤–∫–∞ –Ω–∞ {request.request_type} –æ—Ç {request.name}"
    body = format_contact_email(request)

    # Send email in background
    background_tasks.add_task(send_email, contact_email, subject, body)

    return {
        "status": "success",
        "message": "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
    }

# ======================== DADATA COMPANY LOOKUP ========================

DADATA_API_KEY = os.getenv('DADATA_API_KEY', '')
DADATA_SECRET_KEY = os.getenv('DADATA_SECRET_KEY', '')

@app.post("/api/company/suggest")
async def suggest_company(request: INNLookupRequest):
    """
    –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –ò–ù–ù –∏–ª–∏ –û–ì–†–ù —á–µ—Ä–µ–∑ DaData Suggestions API.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 10 –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å—á—ë—Ç–∞.
    –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç - –Ω–∞—á–∏–Ω–∞–µ—Ç –∏—Å–∫–∞—Ç—å —Å 3 —Å–∏–º–≤–æ–ª–æ–≤.
    """
    query = request.inn.strip()

    if not query:
        raise HTTPException(status_code=400, detail="–ò–ù–ù –∏–ª–∏ –û–ì–†–ù –Ω–µ —É–∫–∞–∑–∞–Ω")

    # –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    if len(query) < 3:
        return {"suggestions": []}

    # –ï—Å–ª–∏ DaData –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    if not DADATA_API_KEY:
        logger.warning("DaData API key not configured, returning mock data")
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        mock_suggestions = []
        base_inns = [
            ("7707083893", "–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫", "117997, –≥ –ú–æ—Å–∫–≤–∞, —É–ª –í–∞–≤–∏–ª–æ–≤–∞, –¥ 19"),
            ("7736050003", "–ü–ê–û –ì–∞–∑–ø—Ä–æ–º", "117997, –≥ –ú–æ—Å–∫–≤–∞, —É–ª –ù–∞–º–µ—Ç–∫–∏–Ω–∞, –¥ 16"),
            ("7703399903", "–û–û–û –Ø–Ω–¥–µ–∫—Å", "119021, –≥ –ú–æ—Å–∫–≤–∞, —É–ª –õ—å–≤–∞ –¢–æ–ª—Å—Ç–æ–≥–æ, –¥ 16"),
            ("7710140679", "–ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º", "191167, –≥ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –Ω–∞–± –°–∏–Ω–æ–ø—Å–∫–∞—è, –¥ 14"),
            ("7702070139", "–ü–ê–û –ú–¢–°", "109147, –≥ –ú–æ—Å–∫–≤–∞, —É–ª –ú–∞—Ä–∫—Å–∏—Å—Ç—Å–∫–∞—è, –¥ 4"),
            ("7743013902", "–ü–ê–û –ú–∞–≥–Ω–∏—Ç", "350072, –≥ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, —É–ª –°–æ–ª–Ω–µ—á–Ω–∞—è, –¥ 15/5"),
            ("7825706086", "–û–û–û –õ–µ–Ω—Ç–∞", "197374, –≥ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª –°–∞–≤—É—à–∫–∏–Ω–∞, –¥ 112"),
            ("7714617793", "–û–û–û –û–∑–æ–Ω", "123112, –≥ –ú–æ—Å–∫–≤–∞, –ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è –Ω–∞–±, –¥ 10"),
            ("7704340310", "–û–û–û –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑", "142181, –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª, –≥ –ü–æ–¥–æ–ª—å—Å–∫"),
            ("5047228659", "–û–û–û –ú–µ–≥–∞–º–∞—Ä–∫–µ—Ç", "140000, –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª, –≥ –õ—é–±–µ—Ä—Ü—ã"),
        ]

        for inn, name, address in base_inns:
            if query in inn or query.lower() in name.lower():
                mock_suggestions.append({
                    "inn": inn,
                    "kpp": inn[:4] + "01001" if len(inn) == 10 else None,
                    "ogrn": "102" + inn + "95"[:13-len(inn)] if len(inn) == 10 else "30" + inn,
                    "name": name,
                    "name_short": name,
                    "name_full": name,
                    "opf": name.split()[0],
                    "type": "LEGAL" if len(inn) == 10 else "INDIVIDUAL",
                    "address": address,
                    "management_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
                    "management_post": "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä",
                    "status": "ACTIVE"
                })
                if len(mock_suggestions) >= 10:
                    break

        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é
        if not mock_suggestions:
            mock_suggestions.append({
                "inn": query + "0" * (10 - len(query)) if len(query) < 10 else query[:10],
                "kpp": "770701001",
                "ogrn": "1027700132195",
                "name": f"–û–û–û ¬´–ö–æ–º–ø–∞–Ω–∏—è {query}¬ª",
                "name_short": f"–û–û–û ¬´–ö–æ–º–ø–∞–Ω–∏—è {query}¬ª",
                "name_full": f"–û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é ¬´–ö–æ–º–ø–∞–Ω–∏—è {query}¬ª",
                "opf": "–û–û–û",
                "type": "LEGAL",
                "address": "123456, –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, –¥. 1",
                "management_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
                "management_post": "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä",
                "status": "ACTIVE"
            })

        return {"suggestions": mock_suggestions}

    try:
        async with httpx.AsyncClient() as client:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º Suggestions API (–∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç), –∞ –Ω–µ findById
            response = await client.post(
                "https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/party",
                headers={
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                    "Authorization": f"Token {DADATA_API_KEY}"
                },
                json={
                    "query": query,
                    "count": 10,
                    "status": ["ACTIVE"]  # –¢–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
                },
                timeout=10.0
            )

            if response.status_code != 200:
                logger.error(f"DaData error: {response.status_code} - {response.text}")
                raise HTTPException(status_code=502, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ DaData")

            data = response.json()
            suggestions = []

            for item in data.get("suggestions", []):
                d = item.get("data") or {}
                name_data = d.get("name") or {}
                address_data = d.get("address") or {}
                management = d.get("management") or {}
                state = d.get("state") or {}
                opf = d.get("opf") or {}

                suggestion = {
                    "inn": d.get("inn"),
                    "kpp": d.get("kpp"),
                    "ogrn": d.get("ogrn"),
                    "name": item.get("value"),
                    "name_short": name_data.get("short_with_opf"),
                    "name_full": name_data.get("full_with_opf"),
                    "opf": opf.get("short"),
                    "type": d.get("type"),  # LEGAL –∏–ª–∏ INDIVIDUAL
                    "address": (address_data.get("unrestricted_value") or address_data.get("value")) if address_data else None,
                    "management_name": management.get("name") if management else None,
                    "management_post": management.get("post") if management else None,
                    "status": state.get("status") if state else None  # ACTIVE, LIQUIDATED, etc.
                }
                suggestions.append(suggestion)

            return {"suggestions": suggestions}

    except httpx.TimeoutException:
        raise HTTPException(status_code=504, detail="–°–µ—Ä–≤–∏—Å DaData –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç")
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"DaData lookup error: {str(e)}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ–º–ø–∞–Ω–∏–∏")

# ======================== QUOTE (–ö–ü) ENDPOINTS ========================

@app.get("/api/services/list")
async def get_services_list():
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç —É—Å–ª—É–≥"""
    return {
        "services": SERVICES_PRICELIST,
        "categories": SERVICE_CATEGORIES
    }

@app.post("/api/quote/create")
async def create_quote(request: QuoteRequest, background_tasks: BackgroundTasks):
    """
    –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ö–ü –Ω–∞ email.
    """
    from datetime import datetime, timedelta

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –ö–ü
    quote_id = f"–ö–ü-{datetime.now().strftime('%Y%m%d')}-{uuid.uuid4().hex[:6].upper()}"

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥ –ø–æ —É—Å–ª—É–≥–∞–º
    services_breakdown = []
    total_amount = 0

    for service in request.services:
        subtotal = service.price * service.quantity
        total_amount += subtotal
        services_breakdown.append({
            "id": service.id,
            "name": service.name,
            "price": service.price,
            "quantity": service.quantity,
            "unit": service.unit,
            "subtotal": subtotal
        })

    # –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
    created_at = datetime.now()
    valid_until = created_at + timedelta(days=14)  # –ö–ü –¥–µ–π—Å—Ç–≤—É–µ—Ç 14 –¥–Ω–µ–π

    quote_data = {
        "quote_id": quote_id,
        "company": request.company.dict(),
        "products": [p.dict() for p in request.products],
        "services_breakdown": services_breakdown,
        "total_amount": total_amount,
        "contact": {
            "name": request.contact_name,
            "phone": request.contact_phone,
            "email": request.contact_email
        },
        "created_at": created_at.isoformat(),
        "valid_until": valid_until.strftime("%d.%m.%Y")
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–ü –Ω–∞ email –≤ —Ñ–æ–Ω–µ
    if request.contact_email:
        email_body = format_quote_email(quote_data)
        background_tasks.add_task(
            send_email,
            request.contact_email,
            f"–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ {quote_id} –æ—Ç –ü—Ä–æ.–ú–∞—Ä–∫–∏—Ä—É–π",
            email_body
        )

    # –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    manager_email = os.getenv('CONTACT_TO_EMAIL', 'damirslk@mail.ru')
    manager_body = format_quote_notification(quote_data)
    background_tasks.add_task(
        send_email,
        manager_email,
        f"–ó–∞—è–≤–∫–∞ –Ω–∞ –ö–ü: {quote_id} –æ—Ç {request.company.name}",
        manager_body
    )

    return {
        "status": "success",
        "quote_id": quote_id,
        "company_name": request.company.name,
        "total_amount": total_amount,
        "services_breakdown": services_breakdown,
        "created_at": created_at.strftime("%d.%m.%Y %H:%M"),
        "valid_until": valid_until.strftime("%d.%m.%Y"),
        "message": "–ö–ü —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ!"
    }

def format_quote_email(quote_data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ö–ü –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É"""
    services_rows = ""
    for idx, s in enumerate(quote_data["services_breakdown"], 1):
        services_rows += f"""
        <tr>
            <td style="padding: 12px; border-bottom: 1px solid #eee;">{idx}</td>
            <td style="padding: 12px; border-bottom: 1px solid #eee;">{s['name']}</td>
            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">{s['quantity']} {s['unit']}</td>
            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">{s['price']:,} ‚ÇΩ</td>
            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">{s['subtotal']:,} ‚ÇΩ</td>
        </tr>
        """

    company = quote_data["company"]

    return f"""
    <html>
    <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #FFDA07 0%, #F5C300 100%); padding: 30px; border-radius: 16px 16px 0 0;">
            <h1 style="margin: 0; color: #000; font-size: 28px;">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h1>
            <p style="margin: 10px 0 0; color: #333; font-size: 16px;">‚Ññ {quote_data['quote_id']}</p>
        </div>

        <div style="background: #fff; padding: 30px; border: 1px solid #eee; border-top: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px; color: #333;">–†–µ–∫–≤–∏–∑–∏—Ç—ã –∑–∞–∫–∞–∑—á–∏–∫–∞</h3>
                <table style="width: 100%;">
                    <tr>
                        <td style="padding: 5px 0; color: #666; width: 150px;">–ö–æ–º–ø–∞–Ω–∏—è:</td>
                        <td style="padding: 5px 0; font-weight: 600;">{company['name']}</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px 0; color: #666;">–ò–ù–ù:</td>
                        <td style="padding: 5px 0;">{company['inn']}</td>
                    </tr>
                    {'<tr><td style="padding: 5px 0; color: #666;">–ö–ü–ü:</td><td style="padding: 5px 0;">' + company.get('kpp', '') + '</td></tr>' if company.get('kpp') else ''}
                    <tr>
                        <td style="padding: 5px 0; color: #666;">–ê–¥—Ä–µ—Å:</td>
                        <td style="padding: 5px 0;">{company.get('address', '‚Äî')}</td>
                    </tr>
                </table>
            </div>

            <h3 style="color: #333; margin-bottom: 15px;">–°–æ—Å—Ç–∞–≤ —É—Å–ª—É–≥</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #FFDA07;">‚Ññ</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #FFDA07;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #FFDA07;">–ö–æ–ª-–≤–æ</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #FFDA07;">–¶–µ–Ω–∞</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #FFDA07;">–°—É–º–º–∞</th>
                    </tr>
                </thead>
                <tbody>
                    {services_rows}
                </tbody>
                <tfoot>
                    <tr style="background: linear-gradient(135deg, #FFDA07 0%, #F5C300 100%);">
                        <td colspan="4" style="padding: 15px; font-weight: bold; font-size: 18px;">–ò–¢–û–ì–û:</td>
                        <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 18px;">{quote_data['total_amount']:,} ‚ÇΩ</td>
                    </tr>
                </tfoot>
            </table>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #FFDA07; margin-bottom: 20px;">
                <strong>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ:</strong> {quote_data['valid_until']}
            </div>

            <div style="text-align: center; padding: 20px;">
                <a href="https://promarkirui.ru/contact" style="display: inline-block; background: linear-gradient(135deg, #FFDA07 0%, #F5C300 100%); color: #000; padding: 15px 40px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 16px;">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                </a>
            </div>
        </div>

        <div style="background: #1f2937; padding: 20px; border-radius: 0 0 16px 16px; text-align: center;">
            <p style="margin: 0; color: #9ca3af; font-size: 14px;">
                –ü—Ä–æ.–ú–∞—Ä–∫–∏—Ä—É–π ‚Äî —Å–µ—Ä–≤–∏—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –ß–µ—Å—Ç–Ω—ã–π –ó–ù–ê–ö<br>
                <a href="https://promarkirui.ru" style="color: #FFDA07;">promarkirui.ru</a> | info@promarkirui.ru
            </p>
        </div>
    </body>
    </html>
    """

def format_quote_notification(quote_data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ö–ü –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    company = quote_data["company"]
    contact = quote_data["contact"]

    services_list = ""
    for s in quote_data["services_breakdown"]:
        services_list += f"‚Ä¢ {s['name']} √ó {s['quantity']} = {s['subtotal']:,} ‚ÇΩ\n"

    return f"""
    <html>
    <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
        <h2 style="color: #1E3A8A;">üéØ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ö–ü #{quote_data['quote_id']}</h2>

        <h3>–ö–æ–º–ø–∞–Ω–∏—è:</h3>
        <ul>
            <li><strong>{company['name']}</strong></li>
            <li>–ò–ù–ù: {company['inn']}</li>
            <li>–ê–¥—Ä–µ—Å: {company.get('address', '‚Äî')}</li>
        </ul>

        <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ:</h3>
        <ul>
            <li>–ò–º—è: {contact['name']}</li>
            <li>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:{contact['phone']}">{contact['phone']}</a></li>
            <li>Email: {contact.get('email', '‚Äî')}</li>
        </ul>

        <h3>–£—Å–ª—É–≥–∏:</h3>
        <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px;">{services_list}</pre>

        <h2 style="color: #059669;">üí∞ –ò—Ç–æ–≥–æ: {quote_data['total_amount']:,} ‚ÇΩ</h2>

        <p style="color: #666; font-size: 12px;">
            –°–æ–∑–¥–∞–Ω–æ: {quote_data['created_at']}<br>
            –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {quote_data['valid_until']}
        </p>
    </body>
    </html>
    """

# ======================== AI CHAT (OpenAI ChatKit) ========================

# ChatKit workflow ID with configured prompt and vector database
CHATKIT_WORKFLOW_ID = os.getenv('CHATKIT_WORKFLOW_ID', 'wf_69333a7229648190a17d2a1519d676ec078aefd89b4f760e')

class ChatMessage(BaseModel):
    role: str
    content: str

class ChatRequest(BaseModel):
    messages: List[ChatMessage]

class ChatKitSessionRequest(BaseModel):
    user_id: Optional[str] = None

@app.post("/api/chatkit/session")
async def create_chatkit_session(request: ChatKitSessionRequest = None):
    """Create a new ChatKit session and return client_secret for frontend"""
    openai_api_key = os.getenv('OPENAI_API_KEY')

    if not openai_api_key:
        raise HTTPException(status_code=500, detail="OpenAI API key not configured")

    try:
        # Generate a unique user ID if not provided
        user_id = request.user_id if request and request.user_id else str(uuid.uuid4())

        async with httpx.AsyncClient() as client:
            # Create ChatKit session using the official API
            response = await client.post(
                "https://api.openai.com/v1/chatkit/sessions",
                headers={
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {openai_api_key}",
                    "OpenAI-Beta": "chatkit_beta=v1"
                },
                json={
                    "workflow": {"id": CHATKIT_WORKFLOW_ID},
                    "user": user_id
                },
                timeout=30.0
            )

            if response.status_code != 200:
                logger.error(f"ChatKit session error: {response.status_code} - {response.text}")
                raise HTTPException(status_code=500, detail="Failed to create ChatKit session")

            data = response.json()
            client_secret = data.get("client_secret")

            return {
                "client_secret": client_secret,
                "workflow_id": CHATKIT_WORKFLOW_ID,
                "user_id": user_id
            }

    except httpx.TimeoutException:
        raise HTTPException(status_code=504, detail="Service timeout")
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"ChatKit session error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to create ChatKit session")

@app.post("/api/chatkit/refresh")
async def refresh_chatkit_session(current_client_secret: str = None):
    """Refresh an existing ChatKit session"""
    openai_api_key = os.getenv('OPENAI_API_KEY')

    if not openai_api_key:
        raise HTTPException(status_code=500, detail="OpenAI API key not configured")

    try:
        async with httpx.AsyncClient() as client:
            response = await client.post(
                "https://api.openai.com/v1/chatkit/sessions/refresh",
                headers={
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {openai_api_key}",
                    "OpenAI-Beta": "chatkit_beta=v1"
                },
                json={
                    "client_secret": current_client_secret
                },
                timeout=30.0
            )

            if response.status_code != 200:
                logger.error(f"ChatKit refresh error: {response.status_code} - {response.text}")
                # If refresh fails, create a new session
                return await create_chatkit_session()

            data = response.json()
            return {"client_secret": data.get("client_secret")}

    except Exception as e:
        logger.error(f"ChatKit refresh error: {str(e)}")
        return await create_chatkit_session()

# Keep the fallback chat endpoint for non-ChatKit usage
@app.post("/api/ai/chat")
async def ai_chat(request: ChatRequest):
    """Fallback AI chat endpoint using OpenAI Chat Completions API"""
    openai_api_key = os.getenv('OPENAI_API_KEY')

    if not openai_api_key:
        raise HTTPException(status_code=500, detail="OpenAI API key not configured")

    FALLBACK_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–ª–µ–∫—Å –ø–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ ¬´–ß–µ—Å—Ç–Ω—ã–π –ó–ù–ê–ö¬ª –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –ü—Ä–æ–ú–∞—Ä–∫–∏—Ä—É–π.
–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. –ü–æ–º–æ–≥–∞–π —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ —Ç–æ–≤–∞—Ä–æ–≤.
–ù–∞ –ª—é–±—ã–µ –Ω–µ—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–∞–π: ¬´–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ. –ü–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É –ø–æ–º–æ—á—å –Ω–µ —Å–º–æ–≥—É.¬ª
–ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å –Ω–∞ promarkirui.ru/check"""

    try:
        messages = [{"role": "system", "content": FALLBACK_PROMPT}]
        for msg in request.messages[-10:]:
            messages.append({"role": msg.role, "content": msg.content})

        async with httpx.AsyncClient() as client:
            response = await client.post(
                "https://api.openai.com/v1/chat/completions",
                headers={
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {openai_api_key}"
                },
                json={
                    "model": "gpt-4o-mini",
                    "messages": messages,
                    "max_tokens": 1000,
                    "temperature": 0.7
                },
                timeout=60.0
            )

            if response.status_code != 200:
                logger.error(f"OpenAI error: {response.status_code} - {response.text}")
                raise HTTPException(status_code=500, detail="AI service error")

            data = response.json()
            return {"response": data["choices"][0]["message"]["content"]}

    except httpx.TimeoutException:
        raise HTTPException(status_code=504, detail="AI service timeout")
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"AI chat error: {str(e)}")
        raise HTTPException(status_code=500, detail="AI service error")

# ======================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–û–í ========================

class ContractGenerateRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–æ–≥–æ–≤–æ—Ä–∞"""
    company: CompanyInfo
    services: List[QuoteService]
    contact_name: str
    contact_phone: str
    contact_email: Optional[str] = None


@app.post("/api/contract/generate")
async def generate_contract(request: ContractGenerateRequest):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF –¥–æ–≥–æ–≤–æ—Ä–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç PDF —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
    """
    try:
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        client_info = {
            "name": request.company.name,
            "name_short": request.company.name_short or request.company.name,
            "inn": request.company.inn,
            "kpp": request.company.kpp or "",
            "ogrn": request.company.ogrn or "",
            "address": request.company.address or "",
            "manager_name": request.company.management_name or request.contact_name,
            "manager_post": request.company.management_post or "–î–∏—Ä–µ–∫—Ç–æ—Ä",
            "basis": "–£—Å—Ç–∞–≤–∞" if request.company.type == "LEGAL" else "–û–ì–†–ù–ò–ü",
        }

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —É—Å–ª—É–≥–∏
        services_list = []
        total_amount = 0
        for s in request.services:
            subtotal = s.price * s.quantity
            total_amount += subtotal
            services_list.append({
                "name": s.name,
                "quantity": s.quantity,
                "unit": s.unit,
                "price": s.price,
                "subtotal": subtotal
            })

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
        pdf_bytes = generate_contract_pdf(
            client_info=client_info,
            services=services_list,
            total_amount=total_amount
        )

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (URL-–∫–æ–¥–∏—Ä—É–µ–º –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞)
        contract_date = datetime.now()
        contract_number = f"DOG-{contract_date.strftime('%d%m%y')}-001"
        filename = f"Contract_{contract_number}_{request.company.inn}.pdf"
        filename_encoded = url_quote(filename)

        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={
                "Content-Disposition": f"attachment; filename=\"{filename}\"; filename*=UTF-8''{filename_encoded}"
            }
        )

    except Exception as e:
        logger.error(f"Contract generation error: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞: {str(e)}")


class QuotePDFRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"""
    quote_id: str
    company: CompanyInfo
    services: List[QuoteService]
    contact_name: str
    contact_phone: str
    contact_email: Optional[str] = None
    valid_until: Optional[str] = None


@app.post("/api/quote/pdf")
async def generate_quote_pdf_endpoint(request: QuotePDFRequest):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç PDF —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
    """
    try:
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        client_info = {
            "name": request.company.name,
            "name_short": request.company.name_short or request.company.name,
            "inn": request.company.inn,
            "kpp": request.company.kpp or "",
            "address": request.company.address or "",
        }

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        contact_info = {
            "name": request.contact_name,
            "phone": request.contact_phone,
            "email": request.contact_email or "",
        }

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —É—Å–ª—É–≥–∏
        services_list = []
        total_amount = 0
        for s in request.services:
            subtotal = s.price * s.quantity
            total_amount += subtotal
            services_list.append({
                "name": s.name,
                "quantity": s.quantity,
                "unit": s.unit,
                "price": s.price,
                "subtotal": subtotal
            })

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
        pdf_bytes = generate_quote_pdf(
            client_info=client_info,
            services=services_list,
            total_amount=total_amount,
            quote_id=request.quote_id,
            contact_info=contact_info,
            valid_until=request.valid_until
        )

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (URL-–∫–æ–¥–∏—Ä—É–µ–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
        from urllib.parse import quote
        filename = f"KP_{request.quote_id}_{request.company.inn}.pdf"
        filename_encoded = quote(filename, safe='')

        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={
                "Content-Disposition": f"attachment; filename*=UTF-8''{filename_encoded}"
            }
        )

    except Exception as e:
        logger.error(f"Quote PDF generation error: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü: {str(e)}")


class ActGenerateRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç"""
    contract_number: str
    contract_date: str  # ISO format date string
    company: CompanyInfo
    services: List[QuoteService]
    contact_name: str


@app.post("/api/act/generate")
async def generate_act(request: ActGenerateRequest):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF –∞–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç PDF —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
    """
    try:
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        client_info = {
            "name": request.company.name,
            "name_short": request.company.name_short or request.company.name,
            "inn": request.company.inn,
            "kpp": request.company.kpp or "",
            "ogrn": request.company.ogrn or "",
            "address": request.company.address or "",
            "management_name": request.company.management_name or request.contact_name,
            "management_post": request.company.management_post or "–î–∏—Ä–µ–∫—Ç–æ—Ä",
        }

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —É—Å–ª—É–≥–∏
        services_list = []
        total_amount = 0
        for s in request.services:
            subtotal = s.price * s.quantity
            total_amount += subtotal
            services_list.append({
                "name": s.name,
                "quantity": s.quantity,
                "unit": s.unit,
                "price": s.price,
                "subtotal": subtotal
            })

        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –¥–æ–≥–æ–≤–æ—Ä–∞
        contract_date = datetime.fromisoformat(request.contract_date.replace('Z', '+00:00'))

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
        pdf_bytes = generate_act_pdf(
            client_info=client_info,
            services=services_list,
            total_amount=total_amount,
            contract_number=request.contract_number,
            contract_date=contract_date
        )

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        act_number = request.contract_number.replace("–î–û–ì", "–ê–ö–¢").replace("DOG", "ACT")
        filename = f"Act_{act_number}_{request.company.inn}.pdf"
        filename_encoded = url_quote(filename)

        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={
                "Content-Disposition": f"attachment; filename=\"{filename}\"; filename*=UTF-8''{filename_encoded}"
            }
        )

    except Exception as e:
        logger.error(f"Act generation error: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∞: {str(e)}")


# ======================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ========================

@app.post("/api/auth/register")
async def api_register(data: UserRegister):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return register_user(data.email, data.password)


@app.post("/api/auth/login")
async def api_login(data: UserLogin):
    """–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É"""
    return login_user(data.email, data.password)


@app.get("/api/auth/me")
async def api_get_me(user: Dict = Depends(require_auth)):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return user


@app.get("/api/auth/verify-email")
async def api_verify_email(token: str):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email –ø–æ —Ç–æ–∫–µ–Ω—É –∏–∑ –ø–∏—Å—å–º–∞"""
    from auth import verify_email
    return verify_email(token)


@app.post("/api/auth/resend-verification")
async def api_resend_verification(user: Dict = Depends(require_auth)):
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    from auth import resend_verification_email
    return resend_verification_email(user["id"], user["email"])


# ======================== –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ========================

@app.get("/api/cabinet/quotes")
async def api_get_user_quotes(user: Dict = Depends(require_auth)):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ö–ü –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    quotes = QuoteDB.get_by_user(user["id"])
    return {"quotes": quotes}


@app.get("/api/cabinet/contracts")
async def api_get_user_contracts(user: Dict = Depends(require_auth)):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    contracts = ContractDB.get_by_user(user["id"])
    return {"contracts": contracts}


@app.get("/api/cabinet/companies")
async def api_get_user_companies(user: Dict = Depends(require_auth)):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    companies = CompanyDB.get_by_user(user["id"])
    return {"companies": companies}


# ======================== –ó–ê–Ø–í–ö–ò –ù–ê –ó–í–û–ù–û–ö ========================

class CallbackRequest(BaseModel):
    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: name/phone (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥) –∏ contact_name/contact_phone
    contact_name: Optional[str] = None
    contact_phone: Optional[str] = None
    name: Optional[str] = None  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    phone: Optional[str] = None  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    contact_email: Optional[str] = None
    company_inn: Optional[str] = None
    company_name: Optional[str] = None
    products: Optional[List[Dict]] = None
    comment: Optional[str] = None
    source: Optional[str] = None  # –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∞ –∑–∞—è–≤–∫–∞: check_page, quote_page, contact_form


def format_callback_email(callback_id: int, data: CallbackRequest, contact_name: str, contact_phone: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ email –¥–ª—è –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–≤–æ–Ω–æ–∫"""
    from datetime import datetime

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∏—Ç–∞–µ–º—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
    source_labels = {
        'check_page': 'üìã –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤',
        'quote_page': 'üìù –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ö–ü',
        'contact_form': 'üìû –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏',
        'unknown': '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    }
    source_label = source_labels.get(data.source, data.source or '–ù–µ —É–∫–∞–∑–∞–Ω')

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    products_html = ""
    if data.products:
        products_html = """
        <h3 style="color: #1E3A8A; margin-top: 20px;">üõí –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:</h3>
        <table style="border-collapse: collapse; width: 100%;">
            <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">–¢–æ–≤–∞—Ä</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">–¢–ù –í–≠–î</th>
                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞</th>
            </tr>
        """
        for p in data.products:
            marking_status = "‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è" if p.get('requires_marking') else (
                "üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç" if p.get('status') == 'experiment' else "‚ùå –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            )
            products_html += f"""
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">{p.get('name', '‚Äî')}</td>
                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">{p.get('tnved', '‚Äî')}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{marking_status}</td>
            </tr>
            """
        products_html += "</table>"

    return f"""
    <!DOCTYPE html>
    <html>
    <head><meta charset="utf-8"></head>
    <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px;">
        <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 20px; border-radius: 12px 12px 0 0;">
            <h1 style="margin: 0; color: #000;">üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ #{callback_id}</h1>
            <p style="margin: 5px 0 0 0; color: rgba(0,0,0,0.7);">{datetime.now().strftime('%d.%m.%Y %H:%M')}</p>
        </div>

        <div style="background: #fff; padding: 20px; border: 1px solid #e5e7eb; border-top: none;">
            <h3 style="color: #1E3A8A; margin-top: 0;">üìç –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞—è–≤–∫–∏:</h3>
            <p style="font-size: 16px; font-weight: bold; color: #059669;">{source_label}</p>

            <h3 style="color: #1E3A8A;">üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</h3>
            <table style="border-collapse: collapse; width: 100%;">
                <tr>
                    <td style="padding: 8px; background-color: #f8f9fa; font-weight: bold; width: 120px;">–ò–º—è:</td>
                    <td style="padding: 8px;">{contact_name}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; background-color: #f8f9fa; font-weight: bold;">–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                    <td style="padding: 8px;"><a href="tel:{contact_phone}" style="color: #2563eb; font-weight: bold;">{contact_phone}</a></td>
                </tr>
                <tr>
                    <td style="padding: 8px; background-color: #f8f9fa; font-weight: bold;">Email:</td>
                    <td style="padding: 8px;">{data.contact_email or '‚Äî'}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; background-color: #f8f9fa; font-weight: bold;">–ö–æ–º–ø–∞–Ω–∏—è:</td>
                    <td style="padding: 8px;">{data.company_name or '‚Äî'}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; background-color: #f8f9fa; font-weight: bold;">–ò–ù–ù:</td>
                    <td style="padding: 8px;">{data.company_inn or '‚Äî'}</td>
                </tr>
            </table>

            {products_html}

            {f'<h3 style="color: #1E3A8A; margin-top: 20px;">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h3><p style="background: #f8f9fa; padding: 12px; border-radius: 8px;">{data.comment}</p>' if data.comment else ''}
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 0 0 12px 12px; text-align: center; border: 1px solid #e5e7eb; border-top: none;">
            <p style="margin: 0; color: #6b7280; font-size: 12px;">–ü—Ä–æ.–ú–∞—Ä–∫–∏—Ä—É–π ‚Ä¢ promarkirui.ru</p>
        </div>
    </body>
    </html>
    """


@app.post("/api/callback/create")
async def api_create_callback(
    data: CallbackRequest,
    background_tasks: BackgroundTasks,
    user: Optional[Dict] = Depends(get_current_user)
):
    """–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–≤–æ–Ω–æ–∫"""
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–æ–ª–µ–π
    contact_name = data.contact_name or data.name or "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
    contact_phone = data.contact_phone or data.phone or "–ù–µ —É–∫–∞–∑–∞–Ω"

    callback_data = {
        "user_id": user["id"] if user else None,
        "contact_name": contact_name,
        "contact_phone": contact_phone,
        "contact_email": data.contact_email,
        "company_inn": data.company_inn,
        "company_name": data.company_name,
        "products": data.products or [],
        "comment": data.comment,
        "source": data.source or "unknown"
    }

    callback_id = CallbackDB.create(callback_data)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    manager_email = os.getenv('CONTACT_TO_EMAIL', 'damirslk@mail.ru')
    source_name = {
        "check_page": "–ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–≤–∞—Ä–∞",
        "quote_page": "–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
        "contact_form": "–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã"
    }.get(data.source or "", "–∑–≤–æ–Ω–∫–∞")
    subject = f"–ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ({source_name}) #{callback_id}"
    body = format_callback_email(callback_id, data, contact_name, contact_phone)
    background_tasks.add_task(send_email, manager_email, subject, body)

    return {"status": "success", "callback_id": callback_id}


# ======================== –ê–î–ú–ò–ù–ö–ê ========================

@app.get("/api/admin/callbacks")
async def api_admin_get_callbacks(user: Dict = Depends(require_admin)):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–≤–æ–Ω–æ–∫ (–∞–¥–º–∏–Ω–∫–∞)"""
    callbacks = CallbackDB.get_all()
    return callbacks


@app.put("/api/admin/callbacks/{callback_id}")
async def api_admin_update_callback(
    callback_id: int,
    data: Dict,
    user: Dict = Depends(require_admin)
):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏"""
    status = data.get("status")
    if status:
        CallbackDB.update_status(callback_id, status)
    return {"success": True}


@app.get("/api/admin/users")
async def api_admin_get_users(user: Dict = Depends(require_admin)):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–¥–º–∏–Ω–∫–∞)"""
    with get_db() as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT id, email, role, is_active, email_verified, created_at FROM users ORDER BY created_at DESC')
        rows = cursor.fetchall()
        return [dict(row) for row in rows]


@app.post("/api/admin/users")
async def api_admin_create_user(
    data: Dict,
    user: Dict = Depends(require_superadmin)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞)"""
    email = data.get("email")
    password = data.get("password")
    role = data.get("role", "client")

    if not email or not password:
        raise HTTPException(status_code=400, detail="Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã")

    if role not in ["client", "admin", "superadmin"]:
        raise HTTPException(status_code=400, detail="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–æ–ª—å")

    existing = UserDB.get_by_email(email)
    if existing:
        raise HTTPException(status_code=400, detail="Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")

    user_id = UserDB.create(email, password, role)
    return {"id": user_id, "email": email, "role": role}


@app.put("/api/admin/users/{user_id}")
async def api_admin_update_user(
    user_id: int,
    data: Dict,
    current_user: Dict = Depends(require_superadmin)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞)"""
    with get_db() as conn:
        cursor = conn.cursor()

        updates = []
        values = []

        if "role" in data:
            if data["role"] not in ["client", "admin", "superadmin"]:
                raise HTTPException(status_code=400, detail="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–æ–ª—å")
            updates.append("role = ?")
            values.append(data["role"])

        if "is_active" in data:
            updates.append("is_active = ?")
            values.append(1 if data["is_active"] else 0)

        if updates:
            values.append(user_id)
            cursor.execute(
                f'UPDATE users SET {", ".join(updates)} WHERE id = ?',
                values
            )

    return {"success": True}


@app.delete("/api/admin/users/{user_id}")
async def api_admin_delete_user(
    user_id: int,
    current_user: Dict = Depends(require_superadmin)
):
    """–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞)"""
    if user_id == current_user["id"]:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è")

    with get_db() as conn:
        cursor = conn.cursor()
        cursor.execute('DELETE FROM users WHERE id = ?', (user_id,))

    return {"success": True}


@app.get("/api/admin/stats")
async def api_admin_get_stats(user: Dict = Depends(require_admin)):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∞–¥–º–∏–Ω–∫–∞)"""
    with get_db() as conn:
        cursor = conn.cursor()

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('SELECT COUNT(*) as cnt FROM users')
        users_count = cursor.fetchone()['cnt']

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π
        cursor.execute('SELECT COUNT(*) as cnt FROM companies')
        companies_count = cursor.fetchone()['cnt']

        # –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫
        cursor.execute('SELECT COUNT(*) as cnt FROM callbacks')
        total_callbacks = cursor.fetchone()['cnt']

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
        cursor.execute("SELECT COUNT(*) as cnt FROM callbacks WHERE status = 'new'")
        new_callbacks = cursor.fetchone()['cnt']

        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞—è–≤–æ–∫
        cursor.execute('''
            SELECT id, contact_name as name, contact_phone as phone, status, created_at
            FROM callbacks
            ORDER BY created_at DESC
            LIMIT 5
        ''')
        recent_callbacks = [dict(row) for row in cursor.fetchall()]

    return {
        "total_users": users_count,
        "total_companies": companies_count,
        "total_callbacks": total_callbacks,
        "pending_callbacks": new_callbacks,
        "recent_callbacks": recent_callbacks
    }


# ======================== –¢–ï–°–¢ –¢–ù –í–≠–î ========================

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –¢–ù –í–≠–î –∏–∑ JSON –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
_tnved_data = None

def get_tnved_data():
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¢–ù –í–≠–î –∏–∑ JSON"""
    global _tnved_data
    if _tnved_data is None:
        import json
        json_path = os.path.join(os.path.dirname(__file__), 'data', 'tnved.json')
        try:
            with open(json_path, 'r', encoding='utf-8') as f:
                _tnved_data = json.load(f)
            logger.info(f"Loaded {len(_tnved_data)} TNVED codes from JSON")
        except FileNotFoundError:
            logger.warning("TNVED JSON not found, returning empty list")
            _tnved_data = []
    return _tnved_data


@app.get("/api/tnved/search")
async def api_tnved_search(q: str = "", limit: int = 50):
    """–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –¢–ù –í–≠–î"""
    if not q or len(q) < 2:
        return {"results": [], "query": q}

    data = get_tnved_data()
    q_lower = q.lower()
    q_digits = q.replace(' ', '')

    results = []
    for item in data:
        # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
        if q_digits.isdigit():
            if item['code'].startswith(q_digits):
                results.append(item)
        # –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        elif q_lower in item['name'].lower():
            results.append(item)

        if len(results) >= limit:
            break

    return {"results": results, "query": q, "count": len(results)}


@app.get("/api/tnved/stats")
async def api_tnved_stats():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –≤—Å–µ–≥–æ –∫–æ–¥–æ–≤ –∏–∑ tnved.json, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö/—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∏–∑ CATEGORIES_DATA"""

    # Total from tnved.json
    data = get_tnved_data()
    total = len(data) if data else 0

    # Mandatory/Experiment from CATEGORIES_DATA (our curated products)
    mandatory = 0
    experimental = 0

    for category in CATEGORIES_DATA:
        for subcategory in category.get("subcategories", []):
            for product in subcategory.get("products", []):
                status = product.get("marking_status", "not_required")
                if status == "mandatory":
                    mandatory += 1
                elif status == "experiment":
                    experimental += 1

    return {
        "loaded": True,
        "total": total,
        "mandatory": mandatory,
        "experimental": experimental,
        "not_required": total - mandatory - experimental
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8001)
