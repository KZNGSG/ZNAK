# План разработки — «Про.Маркируй» (promarkirui.ru)

## 1) Objectives (Цели)
- Дать предпринимателю чёткий ответ «нужна ли маркировка и что делать» за ≤ 2 минуты
- Премиальный, понятный UI (стиль Tinkoff/Stripe), только светлая тема
- Полные воронки: Проверка товара, Импорт, Оснащение, Заявка
- Отправка заявок только на email info@promarkirui.ru (без хранения в БД)
- Статичная логика определения маркировки (категории/подкатегории → результат/план)
- Адаптивность, плавные анимации, валидация форм, маска телефона +7

## 2) Архитектура и ключевые решения
- Стек: FastAPI (0.0.0.0:8001) + React + MongoDB (без сохранения пользовательских данных на MVP)
- Все backend маршруты под префиксом `/api`
- Источники данных: константы/словари в backend (иерархия категорий, правила маркировки, TN ВЭД, сроки, тексты шагов)
- Email: SMTP через переменные окружения (без сторонних сервисов на MVP)
  - SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_USE_TLS, SMTP_FROM, CONTACT_TO_EMAIL (= info@promarkirui.ru)

## 3) Фазы разработки

### Phase 1 — Core POC (Не требуется для данного уровня)
- Уровень приложения: простой бизнес-движок + формы, без внешних SDK/LLM/OAuth — POC можно пропустить.
- Минимальная верификация (во время разработки):
  - Набор unit-функций для «движка решения» (категория/подкатегория/источник/объём → результат)
  - Тест ping/health `/api/health` возвращает OK
  - Ручная проверка SMTP-конфига (логируем попытку, при наличии кредов — отправка тестового письма)

User Stories (Phase 1 acceptance):
1. Как разработчик, я могу получить список категорий и подкатегорий через `/api/check/categories`
2. Как разработчик, я получаю детерминированный результат от `/api/check/assess` по тестовым кейсам
3. Как разработчик, я вижу успешный ответ `/api/health`
4. Как разработчик, я могу выполнить dry-run отправки письма (если нет кредов)
5. Как разработчик, я получаю структурированные причины/шаги в ответе `/api/check/assess`

### Phase 2 — Main App Development (Полное приложение)

A) Backend (FastAPI):
- Endpoints (все под `/api`):
  1. `GET /api/health` — статус
  2. `GET /api/check/categories` — дерево групп/подкатегорий
  3. `POST /api/check/assess` — вход: {category, subcategory, source, volume} → выход: {requires_marking, tnved?, deadline?, steps[], message}
  4. `GET /api/import/countries` — список стран
  5. `GET /api/import/categories` — список категорий для импорта (реюз)
  6. `GET /api/import/schemes` — query: country, category → 3 карточки-схемы (A/B/C)
  7. `POST /api/equipment/recommend` — рекомендации по оборудованию + бюджет
  8. `POST /api/contact/send` — отправка заявки на email через SMTP
- Реализация: словари c правилами, сериализация безопасных типов, обработка ошибок, валидация pydantic
- Env: чтение SMTP_* из окружения; при отсутствии — режим dry-run (лог + 200 с пометкой)

B) Frontend (React):
- Роуты: `/` (Главная), `/check`, `/import`, `/equipment`, `/contact`
- Компоненты UI (стиль premium): hero, карточки преимуществ, карточки действий, прогресс-бар (шаги), формы/радио/чекбоксы/кнопки, disabled-кнопка «Скоро»
- Проверка товара: 3 шага (меню слева + плитка подкатегорий → параметры → результат)
- Импорт: 3 шага (страна → категория → схемы + CTA «Подобрать склад»/«Заказать сопровождение» → ведут на форму заявки)
- Оснащение: 4 шага (тип объекта → объём → что есть → результат с бюджетом)
- Заявка: форма с валидацией, маской +7, чекбокс согласия, успех-экран
- Дизайн: Inter, цвета #1E3A8A / #059669, карточки #F8FAFC, скругления 16/12, тени iOS, плавные hover/transition, иконки lucide
- Все кликабельные элементы получают data-testid

C) Интеграция email (SMTP):
- Подключение по playbook (получим через Integration Agent)
- Переменные окружения, обработка TLS/портов, timeouts, понятные ошибки
- Текст письма: контактные данные + контекст страницы (тип запроса)

D) Тестирование и качество:
- Линт: ruff (backend), ESLint (frontend)
- E2E: testing_agent_v3 (проверка навигации, форм, API)
- Логи supervisor: без ошибок/красных экранов, 0 ошибок в консоли браузера

User Stories (Phase 2 UX):
1. Я, как пользователь, на главной вижу 3 преимущества и 4 карточки действий; «Консультация» недоступна (Скоро)
2. Я могу пройти 3 шага проверки товара и получить вердикт (подлежит/не подлежит) с понятными шагами
3. Я вижу прогресс-бар и могу вернуться на предыдущий шаг без потери выбранных значений
4. Я могу выбрать страну и категорию импорта и получить 3 понятные схемы с плюсами/минусами
5. Я могу пройти 4 шага «Оснащения» и увидеть список оборудования и примерный бюджет
6. Я могу отправить форму заявки, увидеть зелёную галочку и текст успеха
7. Если SMTP не настроен, я вижу аккуратное сообщение об отправке (dry-run) без падений
8. Все страницы красиво выглядят на мобильных/планшетах/desktop
9. Ошибки валидации подсвечены и понятны; телефон имеет маску +7
10. Плитки категорий имеют hover-эффекты и мягкие тени (премиально)

## 4) Эндпоинты и контракты (кратко)
- `GET /api/check/categories` → {groups: [{id, name, subcategories: [{id, name}]}]}
- `POST /api/check/assess` → {requires_marking: bool, category, subcategory, tnved?: string, deadline?: string, steps: string[], message?: string}
- `GET /api/import/countries` → {countries: [{code, name, flagEmoji}]}
- `GET /api/import/schemes?country=CN&category=cosmetics` → {schemes: [{id, title, description, pros:[], cons:[], fitFor:[]}]}
- `POST /api/equipment/recommend` → вход: {facilityType, dailyVolume, has: string[]} → выход: {items:[{name, purpose, priceMin, priceMax, status}], budget:{min, max}}
- `POST /api/contact/send` → вход: {name, phone, email?, requestType, comment?, consent:true} → 200/400; при успехе email уходит на CONTACT_TO_EMAIL

## 5) Next Actions (что делаем сразу)
1. Получить SMTP-конфиг (HOST/PORT/USER/PASS/TLS, FROM). Если нет — разрешить временный dry-run
2. Вызвать Integration Playbook для SMTP и зафиксировать переменные окружения
3. Реализовать backend endpoints и «движок решения» (таблицы правил)
4. Собрать UI по гайдлайнам (получить через design_agent) и связать API
5. Прогнать линтеры и вызвать testing_agent_v3 для end-to-end

## 6) Success Criteria (критерии успеха)
- Все описанные маршруты `/api/*` отвечают и соответствуют контрактам
- Главные 4 экрана и форма заявки работают end-to-end, письма доставляются на info@promarkirui.ru
- Премиальный внешний вид (цвета, тени, градиенты, анимации), без ошибок в консоли
- Пользователь получает результат проверки товара ≤ 2 минут
- Тест-отчёт testing_agent_v3 без критических замечаний; баги, если найдены, исправлены

## 7) Риски и смягчения
- SMTP недоступен/нет кредов → dry-run + явное уведомление, повторная отправка позже
- Неоднозначность правил маркировки → прозрачные сообщения/дисклеймер «актуализируем из официальных источников»
- Мобильная вёрстка сложных плиток → компонентные сетки, упрощение на малых экранах

— Конец плана —